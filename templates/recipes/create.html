{% extends 'base/content.html' %}
{% load widget_tweaks %}
{% block page_title %}Create a recipe{% endblock %}
{% block section_after_nav %}<section class="hero is-light">
      <div class="hero-body">
        <div class="container">
          <h1 class="title">
            Create a recipe
          </h1>
        </div>
      </div>
    </section>{% endblock %}
{% block page_content %}

    <div class="is-centered" v-for="ingredient in liveIngredients" :key="ingredient.name">
        <input type="text" v-model="ingredient.name">
        <input autofocus v-model.trim="ingredient.quantity.number"> <b-select class="is-inline" v-model="ingredient.quantity.unit"
                    size="is-small">
                    <option value="tbsp">US Tablespoon</option>
                    <option value="mL">Milliliter</option>
        </b-select>
    </div>
    <button @click="addIngredient">Add an ingredient</button>
    <form method="post" novalidate action="{{ request.path }}">
    <input name="ingredients" type="hidden" :value="JSON.stringify(liveIngredients)">
    <div class="form-group field is-horizontal">
        <div class="field-label is-medium">
            <label class="label">{{ form.name.label_tag }}</label>
        </div>
        <div class="field-body">
            <div class="field control"> {{ form.name|add_class:"input is-medium" }}
           </div>
         {% if form.name.errors %}
            {% for error in form.name.errors %}
              <div class="invalid-feedback">
                {{ error }}
              </div>
            {% endfor %}
          {% endif %}
        </div>
    </div>
    <div class="form-group field is-horizontal">
        <div class="field-label is-medium">
            <label class="label">{{ form.author.label_tag }}</label>
        </div>
        <div class="field-body">
            <div class="field control"> {{ form.author|add_class:"input is-medium" }}
           </div>
         {% if form.author.errors %}
            {% for error in form.author.errors %}
              <div class="invalid-feedback">
                {{ error }}
              </div>
            {% endfor %}
          {% endif %}
        </div>
    </div>
      {% csrf_token %}
        {% for field in form.vanilla_fields %}
       <div class="form-group field is-horizontal">
       <div class="field-label is-normal">
        <label class="label">{{ field.label_tag }}</label>
       </div>
       <div class="field-body">
           <div class="field control"> {{ field|add_class:"input is-normal" }}
           </div>
         {% if field.errors %}
            {% for error in field.errors %}
              <div class="invalid-feedback">
                {{ error }}
              </div>
            {% endfor %}
          {% endif %}
       </div>
      </div>
        {% endfor %}
    <div class="field is-horizontal">
      <div class="field-label">
        <!-- Left empty for spacing -->
      </div>
      <div class="field-body">
        <div class="field">
          <div class="control">
            <button type="submit" class="button is-success">
              Create
            </button>
          </div>
        </div>
      </div>
    </div>
    </form>

     <script>

      new Vue({
        el: '#app',
        data: {
            searchName: '',
            ingredients: [],
            unitConversionFactor: CONVERSION_FACTORS
        },
          methods: {
            convertToFactor(quantity, dest_unit, type='volumetric') {
                const { unit, value } = quantity;
                const base = this.unitConversionFactor[type].filter(x => x.unit === unit)[0].value;
                let conversionFactor = this.unitConversionFactor[type].filter(x => x.unit === dest_unit)[0].value/base;
                return value*conversionFactor;
            },
              addIngredient() {
                this.ingredients.push({ name: '', type: 'volumetric', quantity: {'unit': 'tbsp', 'number': 0, 'prevUnit': 'tbsp'}})
              }
          },
        computed: {
            liveIngredients() {
              for (const ingredient of this.ingredients) {
                 ingredient.quantity.number = this.convertToFactor({unit: ingredient.quantity.prevUnit, value: ingredient.quantity.number}, ingredient.quantity.unit, 'volumetric');
                 ingredient.quantity.prevUnit = ingredient.quantity.unit;
              }
              return this.ingredients;
            }

        }
      })
  </script>
{% endblock %}
